<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Docling OCR2 UI</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 24px;
        color: #1f2933;
      }
      h1 {
        margin-bottom: 8px;
      }
      .card {
        border: 1px solid #d0d7de;
        border-radius: 8px;
        padding: 16px;
        max-width: 820px;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      button {
        padding: 10px 16px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .progress {
        height: 10px;
        background: #e5e7eb;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 12px;
      }
      .progress-bar {
        height: 100%;
        width: 0%;
        background: #22c55e;
        transition: width 0.2s ease;
      }
      .error {
        color: #b91c1c;
        margin-top: 8px;
      }
      pre {
        white-space: pre-wrap;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 12px;
        border-radius: 6px;
        max-height: 360px;
        overflow: auto;
      }
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th,
      td {
        border: 1px solid #e2e8f0;
        padding: 8px;
        text-align: left;
        vertical-align: top;
      }
      th {
        background: #f1f5f9;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        background: #eef2ff;
        color: #4338ca;
        font-size: 12px;
        white-space: nowrap;
      }
      .muted {
        color: #6b7280;
      }
      .obj-img {
        max-width: 200px;
        max-height: 150px;
        display: block;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
      }
      /* Страницы с bbox (визуализация как в qwenbbox) */
      .pages-section { margin-top: 20px; }
      .pages-section h3 { margin: 0 0 12px 0; color: #334155; }
      .page-cards { display: flex; flex-direction: column; gap: 24px; }
      .page-card {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
      }
      .page-card h4 {
        margin: 0;
        padding: 12px 16px;
        background: #f8fafc;
        font-size: 1rem;
        color: #475569;
      }
      .page-wrapper {
        position: relative;
        display: inline-block;
        max-width: 100%;
        margin: 16px;
        line-height: 0;
      }
      .page-wrapper img {
        display: block;
        max-width: 100%;
        height: auto;
        vertical-align: middle;
      }
      .page-wrapper canvas {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding: 8px 16px 12px;
        font-size: 0.8rem;
        color: #64748b;
      }
      .legend span { display: inline-flex; align-items: center; gap: 6px; }
      .legend i { width: 14px; height: 14px; border: 2px solid; border-radius: 2px; }
    </style>
  </head>
  <body>
    <h1>Docling OCR2</h1>
    <p class="muted">Загрузите PDF, нажмите «Обработать» и посмотрите распознанный текст и объекты (таблицы, изображения, текстовые блоки).</p>

    <div class="card">
      <div class="row">
        <input type="file" id="fileInput" accept="application/pdf" />
        <button id="processBtn">Обработать</button>
      </div>
      <div class="progress" aria-label="progress">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="error" id="error"></div>
    </div>

    <div id="results" style="margin-top: 20px; display: none;">
      <div class="pages-section" id="pagesSection" style="display: none;">
        <h3>Страницы с bbox</h3>
        <div class="legend">
          <span><i style="border-color: #2563eb; background: rgba(37,99,235,0.15);"></i> текст</span>
          <span><i style="border-color: #16a34a; background: rgba(22,163,74,0.15);"></i> таблица</span>
          <span><i style="border-color: #b45309; background: rgba(245,158,11,0.15);"></i> изображение</span>
        </div>
        <div class="page-cards" id="pageCards"></div>
      </div>

      <h3>Распознанный текст</h3>
      <pre id="textOutput"></pre>

      <h3>Объекты на документе</h3>
      <table id="objectsTable">
        <thead>
          <tr>
            <th>Тип</th>
            <th>Страница</th>
            <th>BBox</th>
            <th>Сегмент</th>
            <th>Текст (фрагмент)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      const btn = document.getElementById("processBtn");
      const fileInput = document.getElementById("fileInput");
      const progressBar = document.getElementById("progressBar");
      const errorBox = document.getElementById("error");
      const results = document.getElementById("results");
      const textOutput = document.getElementById("textOutput");
      const objectsTableBody = document.querySelector("#objectsTable tbody");
      const pagesSection = document.getElementById("pagesSection");
      const pageCards = document.getElementById("pageCards");

      const BBOX_COLORS = {
        text:  { stroke: "#2563eb", fill: "rgba(37,99,235,0.12)" },
        table: { stroke: "#16a34a", fill: "rgba(22,163,74,0.12)" },
        image: { stroke: "#b45309", fill: "rgba(245,158,11,0.12)" },
      };

      let fakeProgressTimer;

      function resetUI() {
        errorBox.textContent = "";
        progressBar.style.width = "0%";
        clearInterval(fakeProgressTimer);
        fakeProgressTimer = null;
      }

      function startFakeProgress() {
        let progress = 5;
        progressBar.style.width = `${progress}%`;
        fakeProgressTimer = setInterval(() => {
          progress = Math.min(progress + Math.random() * 15, 92);
          progressBar.style.width = `${progress}%`;
        }, 400);
      }

      function finishProgress() {
        clearInterval(fakeProgressTimer);
        progressBar.style.width = "100%";
      }

      function drawBboxes(canvas, imgEl, elements) {
        if (!elements || !elements.length) return;
        const dw = imgEl.offsetWidth;
        const dh = imgEl.offsetHeight;
        if (!dw || !dh) return;
        canvas.width = dw;
        canvas.height = dh;
        const ctx = canvas.getContext("2d");
        elements.forEach(function(el) {
          const bbox = el.bbox_norm;
          if (!Array.isArray(bbox) || bbox.length < 4) return;
          const x1 = bbox[0] * dw;
          const y1 = bbox[1] * dh;
          const w  = (bbox[2] - bbox[0]) * dw;
          const h  = (bbox[3] - bbox[1]) * dh;
          const type = (el.type || "text").toLowerCase();
          const c = BBOX_COLORS[type] || BBOX_COLORS.text;
          ctx.strokeStyle = c.stroke;
          ctx.fillStyle = c.fill;
          ctx.lineWidth = 2;
          ctx.strokeRect(x1, y1, w, h);
          ctx.fillRect(x1, y1, w, h);
        });
      }

      function renderPages(pages) {
        pageCards.innerHTML = "";
        (pages || []).forEach((p) => {
          const card = document.createElement("div");
          card.className = "page-card";
          const title = document.createElement("h4");
          title.textContent = "Страница " + (p.page || 0);
          card.appendChild(title);
          const wrapper = document.createElement("div");
          wrapper.className = "page-wrapper";
          const img = new Image();
          img.src = "data:image/png;base64," + (p.image_base64 || "");
          const canvas = document.createElement("canvas");
          img.onload = function() {
            drawBboxes(canvas, img, p.elements || []);
          };
          wrapper.appendChild(img);
          wrapper.appendChild(canvas);
          card.appendChild(wrapper);
          pageCards.appendChild(card);
        });
      }

      btn.addEventListener("click", async () => {
        resetUI();
        results.style.display = "none";

        const file = fileInput.files[0];
        if (!file) {
          errorBox.textContent = "Выберите PDF файл.";
          return;
        }

        btn.disabled = true;
        startFakeProgress();

        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch("/parse", { method: "POST", body: formData });
          const data = await response.json().catch(() => ({}));
          finishProgress();

          if (!response.ok) throw new Error(data.error || "Ошибка обработки");

          results.style.display = "block";
          textOutput.textContent = data.text || "";

          if (data.pages && data.pages.length > 0) {
            pagesSection.style.display = "block";
            renderPages(data.pages);
          } else {
            pagesSection.style.display = "none";
          }

          objectsTableBody.innerHTML = "";
          (data.objects || []).forEach((obj) => {
            const row = document.createElement("tr");
            const typeCell = document.createElement("td");
            const pageCell = document.createElement("td");
            const bboxCell = document.createElement("td");
            const segmentCell = document.createElement("td");
            const textCell = document.createElement("td");

            typeCell.innerHTML = `<span class="pill">${obj.type || "N/A"}</span>`;
            pageCell.textContent = (obj.page ?? "—").toString();
            // BBox с точностью до одного знака после запятой
            if (Array.isArray(obj.bbox) && obj.bbox.length >= 4) {
              bboxCell.textContent = obj.bbox.map((x) => Number(x).toFixed(1)).join(", ");
            } else {
              bboxCell.textContent = obj.bbox ? JSON.stringify(obj.bbox) : "—";
            }
            // Сегмент изображения для типа image
            if (obj.type === "image" && obj.image_base64) {
              const img = document.createElement("img");
              img.src = "data:image/png;base64," + obj.image_base64;
              img.alt = "Сегмент";
              img.className = "obj-img";
              segmentCell.appendChild(img);
            } else {
              segmentCell.textContent = "—";
            }
            textCell.textContent = (obj.text || "").slice(0, 200);

            row.appendChild(typeCell);
            row.appendChild(pageCell);
            row.appendChild(bboxCell);
            row.appendChild(segmentCell);
            row.appendChild(textCell);
            objectsTableBody.appendChild(row);
          });
        } catch (err) {
          finishProgress();
          errorBox.textContent = err?.message || String(err);
        } finally {
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>

